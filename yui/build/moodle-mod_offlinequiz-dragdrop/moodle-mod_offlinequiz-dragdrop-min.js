YUI.add("moodle-mod_offlinequiz-dragdrop",function(f,e){var o,u=".actions",i="activity",g="mod-offlinequiz-edit-content",l="editing_move",n="iconsmall",c="jumpmenu",s="left",p="movedown",_="moveup",h="page-content",d="right",m="section",a="section-handle",v="slots",r="sectiondraggable",z="li.page",q="li.slot",t=function(){t.superclass.constructor.apply(this,arguments)};f.extend(t,M.core.dragdrop,{sectionlistselector:null,initializer:function(){if(this.groups=[r],this.samenodeclass=M.mod_offlinequiz.edit.get_sectionwrapperclass(),this.parentnodeclass=M.mod_offlinequiz.edit.get_containerclass(),f.Node.one("."+c))return!1;var e;this.sectionlistselector=M.mod_offlinequiz.edit.get_section_wrapper(f),this.sectionlistselector&&(this.sectionlistselector="."+g+" "+this.sectionlistselector,this.setup_for_section(this.sectionlistselector),(e=new f.DD.Delegate({container:"."+g,nodes:"."+r,target:!0,handles:["."+s],dragConfig:{groups:this.groups}})).dd.plug(f.Plugin.DDProxy,{moveOnEnd:!1}),e.dd.plug(f.Plugin.DDConstrained,{constrain:"#"+h,stickY:!0}),e.dd.plug(f.Plugin.DDWinScroll))},setup_for_section:function(e){f.Node.all(e).each(function(e){var o,i,t,n=f.Moodle.core_course.util.section.getId(e);0<n&&(o=e.one("."+d+" a."+p),i=e.one("."+d+" a."+_),n=M.util.get_string("movesection","moodle",n),t=e.one("."+s),(o||i)&&t&&(t.setStyle("cursor","move"),t.appendChild(this.get_drag_handle(n,a,"icon",!0)),i&&i.remove(),o&&o.remove(),e.addClass(r)))},this)},drag_start:function(e){var o,e=e.target,i=f.Node.create("<"+M.mod_offlinequiz.edit.get_containernode()+"></"+M.mod_offlinequiz.edit.get_containernode()+">");i.addClass(M.mod_offlinequiz.edit.get_containerclass()),(o=f.Node.create("<"+M.mod_offlinequiz.edit.get_sectionwrappernode()+"></"+M.mod_offlinequiz.edit.get_sectionwrappernode()+">")).addClass(M.mod_offlinequiz.edit.get_sectionwrapperclass()),o.setStyle("margin",0),o.setContent(e.get("node").get("innerHTML")),i.appendChild(o),e.get("dragNode").setContent(i),e.get("dragNode").addClass(g)},drag_dropmiss:function(e){this.drop_hit(e)},get_section_index:function(e){var o="."+g+" "+M.mod_offlinequiz.edit.get_section_selector(f),o=f.all(o);return o.indexOf(e)-o.indexOf(f.one("#section-0"))},drop_hit:function(d){var r,l,e,s,o,i=d.drag,c=i.get("node"),t=f.Moodle.core_course.util.section.getId(c),a=t,n=this.get_section_index(c),u=n;if(t!==n){for(o in u<a&&(a=n,u=t),i.get("dragNode").removeClass(g),r=f.Node.all(this.sectionlistselector),l=M.util.add_lightbox(f,c),e={},s=this.get("config").pageparams)s.hasOwnProperty(o)&&(e[o]=s[o]);e.sesskey=M.cfg.sesskey,e.courseid=this.get("courseid"),e.offlinequizid=this.get("offlinequizid"),e.offlinegroupid=this.get("offlinegroupid"),e["class"]="section",e.field="move",e.id=t,e.value=n,i=M.cfg.wwwroot+this.get("ajaxurl"),f.io(i,{method:"POST",data:e,on:{start:function(){l.show()},success:function(e,o){var i,t,n,s;try{(i=f.JSON.parse(o.responseText)).error&&new M.core.ajaxException(i),M.mod_offlinequiz.edit.process_sections(f,r,i,a,u)}catch(d){}n=!1;do{for(n=!1,t=a;t<=u;t++)f.Moodle.core_course.util.section.getId(r.item(t-1))>f.Moodle.core_course.util.section.getId(r.item(t))&&(s=r.item(t-1).get("id"),r.item(t-1).set("id",r.item(t).get("id")),r.item(t).set("id",s),M.mod_offlinequiz.edit.swap_sections(f,t-1,t),n=!0)}while(u-=1,n);window.setTimeout(function(){l.hide()},250)},failure:function(e,o){this.ajax_failure(o),l.hide()}},context:this})}}},{NAME:"mod_offlinequiz-dragdrop-section",ATTRS:{courseid:{value:null},offlinequizid:{value:null},offlinegroupid:{value:null},ajaxurl:{value:0},config:{value:0}}}),M.mod_offlinequiz=M.mod_offlinequiz||{},M.mod_offlinequiz.init_section_dragdrop=function(e){new t(e)},f.extend(o=function(){o.superclass.constructor.apply(this,arguments)},M.core.dragdrop,{initializer:function(){var e;this.groups=["resource"],this.samenodeclass=i,this.parentnodeclass=m,this.samenodelabel={identifier:"dragtoafter",component:"offlinequiz"},this.parentnodelabel={identifier:"dragtostart",component:"offlinequiz"},this.setup_for_section(),e="li."+i,(e=new f.DD.Delegate({container:"."+g,nodes:e,target:!0,handles:["."+l],dragConfig:{groups:this.groups}})).dd.plug(f.Plugin.DDProxy,{moveOnEnd:!1,cloneNode:!0}),e.dd.plug(f.Plugin.DDConstrained,{constrain:"#"+v}),e.dd.plug(f.Plugin.DDWinScroll),M.mod_offlinequiz.offlinequizbase.register_module(this),M.mod_offlinequiz.dragres=this},setup_for_section:function(){f.Node.all(".mod-offlinequiz-edit-content ul.slots ul.section").each(function(e){e.setAttribute("data-draggroups",this.groups.join(" ")),new f.DD.Drop({node:e,groups:this.groups,padding:"20 0 20 0"}),this.setup_for_resource("li.activity")},this)},setup_for_resource:function(e){f.Node.all(e).each(function(e){var o,e=e.one("a."+l);e&&(o=this.get_drag_handle(M.util.get_string("move","moodle"),l,n,!0),e.replace(o))},this)},drag_start:function(e){e=e.target;e.get("dragNode").setContent(e.get("node").get("innerHTML")),e.get("dragNode").all(".icon").setStyle("vertical-align","baseline")},drag_dropmiss:function(e){this.drop_hit(e)},drop_hit:function(e){var o,i=e.drag,t=i.get("node"),e=e.drop.get("node"),n=t.one(u),s=M.util.add_spinner(f,n),d={},r=this.get("config").pageparams;for(o in r)d[o]=r[o];d.sesskey=M.cfg.sesskey,d.courseid=this.get("courseid"),d.offlinequizid=this.get("offlinequizid"),d.offlinegroupid=this.get("offlinegroupid"),d["class"]="resource",d.field="move",d.id=Number(f.Moodle.mod_offlinequiz.util.slot.getId(t)),d.sectionId=f.Moodle.core_course.util.section.getId(e.ancestor("li.section",!0)),(n=t.previous(q))&&(d.previousid=Number(f.Moodle.mod_offlinequiz.util.slot.getId(n))),(e=t.previous(z))&&(d.page=Number(f.Moodle.mod_offlinequiz.util.page.getId(e))),n=M.cfg.wwwroot+this.get("ajaxurl"),f.io(n,{method:"POST",data:d,on:{start:function(){this.lock_drag_handle(i,l),s.show()},success:function(e,o){o=f.JSON.parse(o.responseText),o={element:t,visible:o.visible};M.mod_offlinequiz.offlinequizbase.invoke_function("set_visibility_resource_ui",o),
this.unlock_drag_handle(i,l),window.setTimeout(function(){s.hide()},250),M.mod_offlinequiz.resource_toolbox.reorganise_edit_page()},failure:function(e,o){this.ajax_failure(o),this.unlock_drag_handle(i,a),s.hide(),window.location.reload(!0)}},context:this})},global_drop_over:function(e){var o,i,t;e.drop&&e.drop.inGroup(this.groups)&&(o=e.drag.get("node"),i=e.drop.get("node"),this.lastdroptarget=e.drop,i.hasClass(this.samenodeclass)?(t=this.goingup?"before":"after",i.insert(o,t)):!i.hasClass(this.parentnodeclass)&&!i.test('[data-droptarget="1"]')||i.contains(o)||(this.goingup?i.append(o):i.prepend(o)),this.drop_over(e))}},{NAME:"mod_offlinequiz-dragdrop-resource",ATTRS:{courseid:{value:null},offlinequizid:{value:null},offlinegroupid:{value:null},ajaxurl:{value:0},config:{value:0}}}),M.mod_offlinequiz=M.mod_offlinequiz||{},M.mod_offlinequiz.init_resource_dragdrop=function(e){new o(e)}},"@VERSION@",{requires:["base","node","io","dom","dd","dd-scroll","moodle-core-dragdrop","moodle-core-notification","moodle-mod_offlinequiz-offlinequizbase","moodle-mod_offlinequiz-util-base","moodle-mod_offlinequiz-util-page","moodle-mod_offlinequiz-util-slot","moodle-course-util"]});